# .github/workflows/update-lists.yml
name: Update WhatsApp Lists

on:
  schedule:
    - cron: '0 */6 * * *'  # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 6 Ñ‡Ð°ÑÐ¾Ð²
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v3
    
    - name: âš™ï¸ Setup
      run: |
        sudo apt-get update
        sudo apt-get install -y dnsutils whois curl jq openssl
        # Ð”Ð»Ñ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ CIDR (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
        sudo apt-get install -y sipcalc || true
        
    - name: ðŸ” Discover (Phase 1)
      run: |
        chmod +x scripts/discover.sh
        scripts/discover.sh
        
    - name: ðŸ“Š Generate (Phase 2)
      run: |
        chmod +x scripts/generate-lists.sh
        scripts/generate-lists.sh
        
    - name: âœ… Verify (Phase 3)
      run: |
        chmod +x scripts/verify.sh
        scripts/verify.sh || echo "Verification completed"
        
    - name: ðŸ’¾ Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
        mkdir -p history/
        TIMESTAMP=$(date +%Y%m%d-%H%M)
        cp lists/domains.txt "history/domains-$TIMESTAMP.txt"
        cp lists/cidr.txt "history/cidr-$TIMESTAMP.txt"
        
        # Ð›Ð¸Ð¼Ð¸Ñ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸
        ls -t history/domains-*.txt | tail -n +31 | xargs rm -f 2>/dev/null || true
        ls -t history/cidr-*.txt | tail -n +31 | xargs rm -f 2>/dev/null || true
        
        git add .
        if ! git diff --cached --quiet; then
          git commit -m "Auto-update: $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        else
          echo "No changes to commit"
        fi
